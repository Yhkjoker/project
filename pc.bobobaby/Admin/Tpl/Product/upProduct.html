<include file="Public:header"/>
<!--内容-->
<script>
KindEditor.ready(function(K) {
	K.create('#ke_demo', {
		allowFileManager : true,
		afterBlur: function(){this.sync();}
	});
});

KindEditor.ready(function(K) {
	K.create('#ke_demo_one', {
		allowFileManager : true,
		afterBlur: function(){this.sync();}
	});
});
</script>
<div id="content">
<div id="breadcrumb"> <a href="__APP__/Index/index/cls/1" title="Go to Home" class="tip-bottom"><i class="icon-home"></i>主页</a><span class="nadd">->&nbsp;&nbsp;&nbsp;添加产品</span></div>
<!--breadcrumbs-->

  <div class="container-fluid">

    <div class="quick-actions_homepage">

      <ul class="quick-actions">

	   <li class="bg_lb"> <a href="__APP__/Product/product/catid/<{$cate_arr.catid}>/cls/2"> <i class="icon-dashboard"></i><{$cate_arr.catname}></a></li>

      </ul>

    </div>

<!--End-breadcrumbs-->

 <div class="row-fluid">

     <div class="span12">

        <div class="widget-box">

          <div class="widget-title"> <span class="icon"> <i class="icon-th"></i> </span>

            <h5>新增</h5>

          </div>

          <div class="widget-content nopadding">

          <form  action="__APP__/Product/doProduct/action/edit/id/<{$pro_arr.id}>" method="post" enctype="multipart/form-data">

           <table class="table table-bordered table-striped">

			<tr>

			  <td><span class="needed">*</span>栏目：</td>

			  <td><{$cate_arr.catname}>
			  </td>

			</tr>

			<tr>

			  <td><span class="needed">*</span>标题：</td>

			  <td><input type="text" name="info[title]" datatype="*" nullmsg="标题为空" value="<{$pro_arr.title}>"/>
			  <input type="hidden" name="info[catid]" value="<{$cate_arr.catid}>"/>
			  </td>

			</tr>
			
			
			<tr>

			  <td>二级栏目：</td>

			  <td>
				<select name="info[linkageid]">
					<option value="0">无二级栏目</option>	
					<foreach name="link_list" item="v">
						<option <if condition="$pro_arr.linkageid eq $v[linkageid]">selected</if> value="<{$v.linkageid}>"><{$v.name}></option>	
					</foreach>
				</select>
			  </td>

			</tr>
			
			  <tr>

             	<td><span class="needed">*</span>是否能试用产品：</td>

             	<td><input type="radio" name="info[actstatus]" value="0" <if condition="$pro_arr.actstatus eq 0">checked</if>/>否<input type="radio" name="info[actstatus]" value="1" <if condition="$pro_arr.actstatus eq 1">checked</if>/>是</td>

             </tr>
			<tr>

			  <td>调查卷：</td>

			  <td>
				<select name="info[pmid]">
					<option value="0">请选择调查卷</option>	
					<foreach name="problem_list" item="v">
						<option <if condition="$pro_arr.pmid eq $v[id]">selected</if> value="<{$v.id}>"><{$v.title}></option>	
					</foreach>
				</select>
			  </td>

			</tr>
			
			

			     <tr>

             	<td><span class="needed">*</span>活动介绍：</td>

             	<td><textarea name="info[activity]" id="ke_demo_one" style="width:800px;height:350px;" datatype="*" ignore="ignore" nullmsg="不能为空"><{$pro_arr.activity}></textarea></td>

             </tr>
			
			
             <tr>

             	<td><span class="needed">*</span>内容：</td>

             	<td><textarea name="info[content]" id="ke_demo" style="width:800px;height:350px;" datatype="*" ignore="ignore" nullmsg="不能为空"><{$pro_arr.content}></textarea></td>

             </tr>
			<tr><td><span>上传pc站封面图片：</span></td><td>
			<input type="text" id="url3" name="info[picurlpc]" value="<{$pro_arr.picurlpc}>" class="ke-input-text"/> <input type="button" id="image3" class="btn btn-success delpic" value="选择图片" style="margin-bottom:10px"/>
</td></tr>

		</tr>
					<tr><td><span> 价格信息：</span></td><td>
						<table width="950" >
     
							<tbody>
								<tr>
									<th width="100" style="background-color: #f5f5f5;">容量</th>
									<th width="100" style="background-color: #f5f5f5;">价格</th>	
									<th width="300" style="background-color: #f5f5f5;">材质</th>	
									<th width="350" style="background-color: #f5f5f5;">封面图</th>	
									<th width="50" style="background-color: #f5f5f5;"></th>
							  </tr>
							 </tbody>
							 
							 <tbody id="addTrr">
						<foreach name="price_list" item="v" key="k">
							 
								<tr id="d_<{$v.id}>">
									<td>
											<input type="text"  style="width:100px;" name="info_price_up[<{$v.id}>][capacity]" value="<{$v.capacity}>"/>	
									</td>
									<td>
											<input type="text"  style="width:100px;"  name="info_price_up[<{$v.id}>][price]" value="<{$v.price}>"/>
									</td>
									  <td >
									<ul >
								  <foreach name="texture_list" item="vo">

										<li style="float:left;"><div><input type="checkbox" name="info_price_up[<{$v.id}>][texturelist][]" value="<{$vo.id}>"  <foreach name="v[texturelist]" item="val" ><if condition="$val eq $vo[id]">checked</if></foreach>><{$vo.colorname}></div></li>
	
								  </foreach>
									</ul>
								  </td>
									
									<td>
												<input type="file"  name="fmpicurl[]"  class="ke-input-text" /><img src="<{$v.fmpicurl}>" width="70" height="39"/>
									</td>
									
									<td>
											<a style='color:#307cb8;cursor:pointer;' onClick='getIDDele(<{$v.id}>,"d_<{$v.id}>")'> 删除</a>
									</td>
								</tr>
					</foreach>
						
						  </tbody>
						
							<tbody><tr>
								<td style="border:none;" colspan="2">
								<div class="fl zjjgqj">
									<a id="getCtr" href="javascript:void(0);">
											<img src="__PUBLIC__/aimages/jia.jpg">
									<span>增加价格区间 </span>
									</a>
								</div>
								</td>
								</tr>
							
						  </tbody></table>

					

		</td></tr>
		

		
		
		<style type="text/css">
         .htdian{ float: left;}
         .htdian input { margin-top: -3px; }
         .htdiansp{display: inline-block !important;  margin: 0 0 -5px 5px; }
         .httxt{padding-left: 5px;}
         .htcswai{ display: block; }
         .htcs{display: inline-block  }
         .htphoto{ display: block; }
		</style>
		
		<tr><td colspan="2">
				<div id="J_imageView">
				<?php
						if($pro_arr['picurlpcall']){
							$pic_list=explode(",",$pro_arr['picurlpcall']);
							$color_list=explode(",",$pro_arr['colorlist']);
							$data="";
							
								foreach($pic_list as $ke=>$va){
									$data.="<div id='img$ke'>";
								 foreach($para_list as $k=>$vo){
				
										$data.= '<div class="htdian" style="width:100px;"><span><input type="radio" name="info[colorlist]['.$ke.']" value="'.$vo['id'].'" ';
	
											if($color_list[$ke]==$vo['id'] || $k==0){
												$data.='checked';
											}
										$data.=' item="val"></span><span class="httxt">'.$vo['name'].'</span><span class="htdiansp" style="width: 20px;height: 20px;display: block;background-color:'.$vo['colorname'].';"></span></div>';						
									}
							

								
					$data.="<p><img src='$va' class='allImg htphoto' width='200px' heigth='200px'/></p><a href='javascript:shanchu($ke)' >delete</a><hr/></div>";
                        
						}
						echo $data;
					}
		        ?>
		</div>
				
				</td></tr>

			<tr>
		

			  <td><span class="needed">*</span>发表时间：</td>

			  <td><input type="hidden" name="info[picurlpcall]" id="purl" value="<{$pro_arr.picurlpcall}>"/><input type='text' name='info[updatetime]' value="<?php  echo date('Y-m-d H:i:s',time()); ?>" class='text-input small-input Wdate'  onBlur="FireEvent(this,'onchange');" onFocus="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss',readOnly:true})"   readonly=""/></td>

			</tr>

             <tr>

             	<td colspan="2"><input type="reset" class="an" value="重置信息"/>&nbsp;&nbsp;<input type="button" id="J_selectImage" class="an" value="批量上传" />&nbsp;&nbsp;<input type="submit" value="保存发布" name="dosubmit"  class="an"/></td>

             </tr>

          </table>

          </form>

          <script type="text/javascript">
			  $('.myForm').Validform({

				tiptype:3,

				ajaxPost:true,

				callback:function(data){

					if(data.status=='y'){

						setTimeout(function(){window.location="__APP__/Product/product/catid/<{$cate_arr.catid}>/cls/2";},1000);

					}

				}

			  })
			  
			KindEditor.ready(function(K) {
			var editor = K.editor({
					allowFileManager : true
				});
				K('#image3').click(function() {
					editor.loadPlugin('image', function() {
						editor.plugin.imageDialog({
							showRemote : false,
							imageUrl : K('#url3').val(),
							clickFn : function(url, title, width, height, border, align) {
								K('#url3').val(url);
								editor.hideDialog();
							}
						});
					});
				});
			});
var string = '<{$msg}>';			
KindEditor.ready(function(K) {
				var editor = K.editor({
				});
				var _id = 0;
				K('#J_selectImage').click(function() {			
					editor.loadPlugin('multiimage', function() {
						editor.plugin.multiImageDialog({
					
						clickFn : function(urlList) {
								var url=document.getElementById("purl").value;									
								var div = K('#J_imageView');
								K.each(urlList, function(i, data) {
											string = string.replace(/xxx\d/g,"xxx"+_id);
											div.append('<div>'+string+'<p><img src="'+data.url+'" width="200px" height="200px"/></p><hr/></div>');
											url=url+","+data.url;	
												_id++;
									
								});		
								
								if (url.substr(0,1)==',') 
								url=url.substr(1);
								
								document.getElementById("purl").value=url;
								
								editor.hideDialog();
							}
						});
					});
				});
			});
			
			

$(function(){
	var k=0;
    $("#getCtr").click(function(){     
		var y_id=$("#addTrr tr").length;
        var str='';
        str+="<tr id='p"+y_id+"'>";
        str+="<td> <input type='text' style='width:100px'   name='info_price[capacity][]' /></td>";
		str+="<td> <input type='text' style='width:100px;' name='info_price[price][]'/></td>";
		str+="<td ><ul >";
				<foreach name="texture_list" item="v">
						str+='<li style="float:left;"><div><input type="checkbox" name="info_price[newtexturelist]['+k+'][]" value="<{$v.id}>"><{$v.colorname}></div></li>';
				</foreach>
		str+="</ul></td>";	
		str+='<td><input type="file"  name="fmpicurl[]" class="ke-input-text"/> </td>';		
		str+="<td><a style='color:#307cb8;cursor:pointer;' onClick='getDele(this)'> 删除</a></td>";
        str+="</tr>";
		k++;
			$("#addTrr").append(str);
			
    });
});
function getDele(j){
    $(j).parent().parent().remove();     
}
function getIDDele(val,j){
		$.ajax({
			type:"POST",
			url:"__APP__/Product/delPric",
			data:"id="+val,
			success:function(data){
					if(data){
						 $("#"+j).remove(); 
					
					
					}
			
			
			}
		
		
		
		})
		
			

	
}
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
			
function shanchu(val){

			var div=document.getElementById('img'+val)
			div.parentNode.removeChild(div);
			var purl="";
			$("#J_imageView img.allImg").each(function(){
			
			  purl+=$(this).attr("src")+",";

			})
				 if (purl.length > 0) {
					purl = purl.substring(0, purl.length - 1);
				}
			
				document.getElementById("purl").value=purl;
			
			}
		</script>
		

          </div>

        </div>

    </div>

  </div>

  <div class="row-fluid">

<include file="Public:footer"/>